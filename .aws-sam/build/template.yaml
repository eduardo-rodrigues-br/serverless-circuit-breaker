AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 'Serverless Circuit Breaker

  Sample SAM Template for Serverless Circuit Breaker

  '
Globals:
  Function:
    Timeout: 3
    Runtime: nodejs14.x
    Environment:
      Variables:
        CIRCUIT_BREAKER_TABLE_NAME:
          Ref: CircuitBreakersTable
Resources:
  PaymentsHttpApi:
    Type: AWS::Serverless::HttpApi
    Properties:
      DefinitionBody:
        Fn::Transform:
          Name: AWS::Include
          Parameters:
            Location: ../../definitions/api.yaml
  CircuitBreakerStateMachine:
    Type: AWS::Serverless::StateMachine
    Properties:
      DefinitionUri: ../../statemachine/circuit-breaker.asl.json
      Tracing:
        Enabled: true
      DefinitionSubstitutions:
        DefaultFunctionName:
          Ref: DefaultFunction
        FallbackFunctionName:
          Ref: FallbackFunction
        CircuitBreakersTable:
          Ref: CircuitBreakersTable
      Policies:
      - LambdaInvokePolicy:
          FunctionName:
            Ref: DefaultFunction
      - LambdaInvokePolicy:
          FunctionName:
            Ref: FallbackFunction
      - DynamoDBCrudPolicy:
          TableName:
            Ref: CircuitBreakersTable
      Type: EXPRESS
  DefaultFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: DefaultFunction
      Handler: make-payment.handler
  FallbackFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: FallbackFunction
      Handler: make-payment-fallback.handler
  FillCircuitBreaker:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: FillCircuitBreaker
      Handler: fill-circuit-breaker.handler
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: CircuitBreakersTable
  CircuitBreakersTable:
    Type: AWS::Serverless::SimpleTable
    Properties:
      TableName:
        Fn::Sub: CircuitBreakers
  HttpApiRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - apigateway.amazonaws.com
          Action:
          - sts:AssumeRole
      Policies:
      - PolicyName: AllowSFNExec
        PolicyDocument:
          Version: 2012-10-17
          Statement:
          - Effect: Allow
            Action: states:StartSyncExecution
            Resource:
              Fn::GetAtt:
              - CircuitBreakerStateMachine
              - Arn
  CircuitBreaker:
    Type: Custom::CircuitBreaker
    DependsOn:
    - CircuitBreakersTable
    - FillCircuitBreaker
    Version: '1.0'
    Properties:
      DefaultFunction:
        Ref: DefaultFunction
      ServiceToken:
        Fn::GetAtt:
        - FillCircuitBreaker
        - Arn
Outputs:
  PaymentApi:
    Description: API Gateway endpoint URL for Prod stage for Payments API
    Value:
      Fn::Sub: https://${PaymentsHttpApi}.execute-api.${AWS::Region}.amazonaws.com/payment
  DefaultFunction:
    Description: Default function ARN
    Value:
      Fn::GetAtt:
      - DefaultFunction
      - Arn
  FallbackFunction:
    Description: Fallback function ARN
    Value:
      Fn::GetAtt:
      - FallbackFunction
      - Arn
